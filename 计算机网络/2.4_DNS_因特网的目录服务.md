### 2.4.1 DNS提供的服务

识别主机有两种方式，通过主机名或者IP地址。

主机名到IP地址转换的目录服务就是**域名系统**（Domain Name System, DNS）的主要任务。

DNS是（1）一个由分层的**DNS服务器**（DNS server）实现的分布式数据库；（2）一个使得主机能够查询分布式数据库的应用层协议。

DNS服务器通常时运行BIND软件的UNIX机器。DNS协议运行在UDP之上，使用53号端口。

【为什么用UDP而非TCP？】

DNS是一个应用层协议，因为其使用客户-服务器模式运行在通信的端系统之间，且在通信的端系统之间通过下面的端到端运输协议来传送DNS报文。但是DNS不是一个直接和用户打交道的应用，相反，DNS是为因特网上的用户应用程序以及其他软件提供一种核心功能，即将主机名转换为背后的IP地址。

DNS通常是由其他应用层协议所使用的，包括HTTP、SMTP和FTP，将用户提供的主机名解析为IP地址。例如，考虑运行在某用户主机上的一个浏览器（即一个HTTP客户）请求URL www.someschool.edu/index.html页面。 为了使用户的主机能够将一个HTTP请求报文发送到Web服务器www.someschool.edu，该用户主机必须获得该域名的IP地址，步骤如下：

1. 同一台用户主机上运行着DNS应用的客户端。
2. 浏览器从上述URL中抽取出主机名www.someschool.edu，并将这台主机名传给DNS应用的客户端。
3. DNS客户向DNS服务器发送一个包含主机名的请求。
4. DNS客户最终会收到一份回答报文，其中含有对应于该主机名的IP地址。
5. 一旦浏览器接收到来自DNS的该IP地址，它能够向位于该IP地址80端口的HTTP服务器进程发起一个TCP连接。

**主机别名**（host aliasing）

有着复杂主机名的主机能拥有一个或者多个别名。

**规范主机名**（canonical hostname）

**邮件服务器别名**（mail server aliasing）

**负载分配**（load distribution） DNS也用于在冗余的服务器（如冗余的Web服务器）之间进行负载分配。繁忙的站点被冗余分布在多台服务器上，每台服务器均运行在不同的端系统上，每个都有着不同的IP地址。由于这些冗余的Web服务器，一个IP地址集合因此与同一个规范主机名相联系。DNS数据库中存储着这些IP地址集合。当客户对映射到某地址集合的名字发出一个DNS请求时，该服务器用IP地址的整个集合进行响应，但在每个回答中循环这些地址次序。因为客户通常总是向IP地址排在最前面的服务器发送HTTP请求报文，所以DNS就在所有这些冗余的Web服务器之间循环分配了负载。

### 2.4.2 DNS工作机理概述

#### 1 分布式、层次数据库

为了处理扩展性问题，DNS使用了大量的DNS服务器，它们以层次方式组织，并且分布在全世界范围内。大致来说，有3种类型的DNS服务器：**根DNS服务器**、**顶级域（Top-Level Domain, TLD）DNS**以及**权威DNS服务器**。

例如，假定一个DNS客户要获取主机名www.amazon.com的IP地址。粗略说来，客户首先与根服务器之一联系，它将返回顶级域名com的TLS服务器的IP地址。该客户则于这些TLD服务器之一联系，它将为amazon.com返回权威服务器的IP地址。最后，该客户与amazon.com权威服务器之一联系，它为主机名www.amazon.com返回其IP地址。

**本地DNS服务器**

当主机发出DNS请求时，该请求被发往本地DNS服务器，它起着代理的作用，并将该请求转发到DNS服务器层次结构中。

实践中，通常从请求主机到本地DNS服务器的查询是递归的，其余的查询是迭代的。

#### 2 DNS缓存

为了改善时延性能并减少在因特网上到处传输的DNS报文数量，DNS广泛使用了缓存技术。原理很简单，在一个请求链中，当某DNS服务器接收一个DNS回答（例如包含某主机名到IP地址的映射）时，它能将映射缓存在本地存储器中。

### 2.4.3 DNS记录和报文

共同实现DNS分布式数据库的所有DNS服务器存储了**资源记录**（Resource Record,RR），RR提供了主机名到IP地址的映射。每个DNS回答报文包含了一条或多条资源记录。

资源记录是一个包含了下列字段的4元组：[Name, Value, Type, TTL],TLL是该记录的生存时间，它决定了资源记录应当从缓存中删除的时间。Name和Value的值取决于Type。

+ 如果Type=A，则Name是主机名，Value是该主机名对应的IP地址。
+ 如果Type=NS，则Name是个域（如foo.com）而Value是个知道如何获取该域中主机IP地址的权威DNS服务器的主机名。
+ 如果Type=CNAME，则Value是别名为Name的主机对应的规范主机名。
+ 如果Type=MX，则Value是个别名为Name的邮件服务器的规范主机名。

#### 1 DNS报文

DNS只有查询和回答两种报文，并且，查询和回答报文有着相同的格式。

前十二个字节是**首部区域**，其中有几个字段，包括：标识符、标志、问题数、问答RR数、权威RR数、附加RR数。

**问题区域**包含着正在进行的查询信息。该区域包括：（1）名字字段，包含正在被查询的主机名字；（2）类型字段，指出有关该名字的正被询问的问题类型。

**回答区域**包含了对最初请求的名字的资源记录。

**权威区域**包含了其他权威服务器的记录。

**附加区域**包含了其他有帮助的记录。

#### 2 在DNS数据库中插入记录

略
