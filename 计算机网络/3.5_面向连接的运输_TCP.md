### 3.5.1 TCP连接

TCP被称为是**面向连接的**（connection-oriented）,这是因为在一个应用进程可以开始向另一个应用进程可以开始向另一个应用进程发送数据之前，这两个进程必须先相互‘握手’，即它们必须相互发送某些预备报文段，以建立确保数据传输的参数。作为TCP建立连接的一部分，连接的双方都将初始化与TCP连接相关的许多TCP状态变量。

TCP连接是**点对点**（point-to-point）的，即在单个发送方与单个接收方之间的连接。

客户首先发送一个特殊的TCP报文段，服务器用另一个特殊的TCP报文段来响应，最后，客户再用第三个特殊报文段作为响应。前两个报文段不承载‘有效载荷’，也就是不包含应用层数据；而第三个报文段可以承载有效载荷。由于在这两台主机之间发送了3个报文段，所以这种连接建立过程常被称为**三次握手**（three-way handshake）

一旦建立起一条TCP连接，两个应用进程之间就可以相互发送数据了。

客户进程通过套接字传毒数据流，数据一旦通过套接字，就由客户中运行的TCP控制了。TCP将这些数据引导到该连接的**发送缓存**（send buffer）里，发送缓存是发起三次握手期间设置的缓存之一。接下来TCP就会不时地从发送缓存中取出一块数据，并将数据传递到网络层。

TCP可以从缓存中取出并放入报文段中的数据数量受限于**最大报文段长度**（Maximum Segment Size, MSS）.MSS通常根据最初确定的由本地主机发送的最大链路层帧长度（即**最大传输单元**（Maximum Transmission Unit, MTU）)来设置。

TCP为每块客户数据配上一个TCP首部，从而形成多个**TCP报文段**（TCP segment）。这些报文段被下传给网络层，网络层将其分别封装在网络层IP数据报中。然后这些IP数据报被发送到网络中。当TCP在另一端接收到一个报文段后，该报文段的数据就被放入该TCP连接的接收缓存中。

TCP连接的组成包括：一台主机上的缓存、变量和与进程连接的套接字，以及另一台主机上的另一组缓存、变量和与进程连接的套接字。

### 3.5.2 TCP报文段结构

TCP的首部一般是20字节（比UDP首部多12字节）

首部包括：
+ **源端口号**和**目的端口号**，被用于多路复用/分解来自或发送到上层应用的数据。
+ **检验和**，检查比特错误。
+ 32比特的**序号字段**（sequence number field）和32比特的**确认号字段**（acknowledgment number field）：这些字段被TCP发送方和接收方用来实现可靠数据传输服务。
+ 16比特的**接收窗口字段**（recieve window field），该字段用于流量控制。该字段用于指示接收方愿意接收的字节数量。
+ 4比特的**首部长度字段**（header length field），该字段指示了以32比特的字为单位的TCP首部长度。由于TCP选项字段的原因，TCP首部的长度是可变的。（通常，选项字段为空，所以TCP首部的典型长度是20字节）
+ 可选与变长的**选项字段**（option field），该字段用于发送方和接收方协商最大报文段长度（MSS）时，或在高速网络环境下用作窗口调节因子时使用。首部字段中还定义了一个时间戳选项。
+ 6比特位的**标志字段**（flag field）。（CWR,ECE,URG,ACK,PSH,RST,SYN,FIN）**ACK比特**用于指示确认字段中的值是有效的，即该报文段包括一个对已被成功接收报文段的确认。**RST**、**SYN**和**FIN**比特用于连接建立和拆除。在明确拥塞通告中使用了**CWR**和**ECE**比特。当**PSH比特**被置位时，就指示接收方应立即将数据交给上层。**URG比特**用来指示报文段里存在着被发送端的上层体置为‘紧急’的数据。紧急数据中的最后一个字段由16比特的**紧急数据指针字段**（urgent data pointer field）指出。当紧急数据存在并给出指向紧急数据尾指针的时候，TCP必须通知接收端的上层实体（在实践中，PSH、URG和紧急数据指针并没有使用。）

#### 1 序号和确认号

