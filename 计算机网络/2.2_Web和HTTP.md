### 2.2.1 HTTP概况

Web的应用层协议是**超文本传输协议**（HyperText Transfer Protocol, HTTP）。HTTP由两个程序实现，一个客户程序和一个服务器程序。客户和服务器程序一般运行在不同的端系统中，通过交换HTTP报文进行会话。HTTP定义了这些报文的结构以及客户和服务器进行报文交换的方式。

HTTP使用TCP作为它的支撑运输协议。

HTTP客户首先发起一个与服务器的TCP连接，一旦连接建立，该浏览器和服务器进程就可以通过套接字接口访问TCP。客户向它的套接字接口发送HTTP请求报文并从它的套接字接口接收HTTP响应报文。服务器也类似。

HTTP是一个无状态协议，也就是说HTTP服务器并不保存关于客户的任何信息。

### 2.2.2 非持续连接和持续连接

**非持续连接**（non-persistent connection）：每个请求/响应对是经一个单独的TCP连接发送。

**持续连接**（persistent connection）：所有的请求及响应经相同的TCP连接发送。

HTTP既能使用非持续连接，也能使用持续连接。HTTP默认方式下使用持续连接，不过HTTP客户和服务器也能配置成使用非持续连接。

**往返时间**（往返时间 Round-Trip Time，RTT）：一个短分组从客户到服务器然后再返回客户所花费的时间。RTT包括分组传播时延、分组在中间路由器和交换机上的排队时延以及分组处理时延。

简单估算，从客户请求HTML基本文件到该客户收到整个文件所花费的时间。粗略的讲， 总的响应时间就是两个**RTT**（往返时间 Round-Trip Time）加上服务器传输HTML文件的时间（三次握手）。

1 采用非持续连接的HTTP

缺点：第一，分别为每一个请求的对象建立和维护一个全新的连接。对于每个这样的连接，在客户和服务器中都要分配TCP的缓冲区和保持TCP变量。第二，每一个对象经受两倍的**RTT**（往返时间 Round-Trip Time）交付时延。即一个RTT用于创建TCP，另一个RTT用于请求和接收一个对象。

2 采用持续连接的HTTP 

没有上述非持续性连接的缺点

【Q：那么，非持续连接的优点是什么呢？】
【Q：那么，持续连接的缺点是什么呢？为什么会有人选择非持续性连接】

### 2.2.3 HTTP报文格式

HTTP规范 [ RFC 1945; RFC 2616; RFC 7540 ]包含了对HTTP报文格式的定义。HTTP报文有两种：请求报文和响应报文。

#### 1 HTTP请求报文

典型例子如下：

```
GET /somedir/page.html HTTP/1.1
Host: www.someschool.edu
Connection: close
User-agent: Mozilla/5.0
Accept-language: fr
```
HTTP报文的第一行叫作**请求行**（request line），其后继的行叫作**首部行**（header line）。

如上所示，请求行有三个字段：方法字段、URL字段和HTTP版本字段。方法包括GET,POST,HEAD,PUT和DELETE。URL字段带有请求对象的标识（统一资源定位符）。

首部行Host指明了请求对象所在的主机。（该首部行提供的信息是Web代理高速缓存所要求的）。

Connection：close首部告诉服务器不要使用持续连接，它要求服务器在发送完被请求的对象后就关闭这条连接。

User-agent: 用来指明用户代理，即向服务器发送请求的浏览器的类型。

Accept-language：标识用户想得到该对象的特定语言的版本（存在则发送，否则，发送默认版本）。

**实体体**（entity body）：方法为POST时，可以使用实体体来传输数据（例如表单，虽然表单生成的请求报文也不是必须使用POST..）。

HEAD类似GET但不返回请求对象，主要用于调试跟踪。

PUT允许用户上传对象到指定的Web服务器上指定的路径

DELETE允许用户或应用程序删除Web服务器上的对象

#### 2 HTTP响应报文

典型例子如下：
```
HTTP/1.1 200 ok
Connection: close
Date: Tue, 18 Aug 2015 15:44:04 GMT
Server: Apache/2.2.3 (CnetOS)
Last-Modified: Tue, 18 Aug 2015 15:11:03 GMT
Content-Length: 6821
Content-Type: text/html

(data data data ...)
```
如上所示，响应报文分为三个部分：一个初始**状态行**（status line），6个**首部行**（header line），然后是**实体体**（entity body）。

实体体部分是报文的主要部分，即它包含了所请求的对象本身。

状态行有三个字段：协议版本字段、状态码及相应的状态信息。

Connection: close，服务器利用该首部行通知客户，在发送完报文后将关闭该TCP连接。

Date:首部行指示服务器产生并发送该响应报文的日期和时间。

Server:首部行指示该报文是由一台Apache Web服务器产生的。

Last-Modified:首部行指示了对象创建或最后修改的日期和时间,该首部行对既可能在本地客户也可能在网络缓存服务器上的对象缓存来说非常重要。

Content-Length:首部行指示了被发送对象中的字节数

Content-Type:首部行指示了实体体中的对象的类型，示例中是HTML文本。

常见状态码：200，301，304，400，401，404，500，504，505等。

### 2.2.4 用户与服务器的交互：cookie

cookie允许站点对用户进行追踪。

cookie技术有四个组件：

1. 在HTTP响应报文中的一个cookie首部行
2. 在HTTP请求报文中的一个cookie首部行
3. 在用户端系统中保留有一个cookie文件，并由用户的浏览器进行管理。
4. 位于Web站点的一个后端数据库。

### 2.2.5 Web缓存

**Web缓存器**（Web cache）也叫**代理服务器**（proxy server），它是能够代表初始Web服务器来满足HTTP请求的网络实体。Web缓存器有自己的磁盘存储空间，并在存储空间中保存最近请求过的对象的副本。

可以配置用户的浏览器，使得用户的所有HTTP请求首先指向Web缓存器。

例如：浏览器正在请求某一对象：

1. 浏览器创建一个到Web缓存器的TCP连接，并向Web缓存器中的对象发送一个HTTP请求。
2. Web缓存器进行检查，看看本地是否存储了该对象副本。如果有，Web缓存器就向客户浏览器用HTTP响应报文返回该对象。
3. 如果Web缓存器中没有该对象，它就打开一个与该对象的初始服务器的TCP连接。Web缓存器在这条TCP连接上发送一个对该对象的HTTP请求，在收到请求后，初始服务器向该Web缓存器发送具有该对象的HTTP响应。
4. 当Web缓存器接收到该对象时，它在本地存储空间存储一份该对象的副本，并向客户的浏览器用HTTP响应报文发送该副本。

好处： （1）大大减少对客户请求的响应时间。（2）大大减少一个机构的接入链路到因特网的通信量，因此降低费用。此外，Web缓存器能从整体上大大减低因特网上的Web流量，从而改善了所有应用的性能。

**内容分发网络**（Content Distribution Network， CDN）

### 2.2.6 条件GET方法

HTTP协议有一种机制，允许缓存器证实它的对象是最新的。这种机制就是**条件GET方法**

如果一个HTTP请求报文使用GET方法且首部存在‘If-Modified-Since’，那么这个HTTP请求报文就是一个条件GET请求报文。
